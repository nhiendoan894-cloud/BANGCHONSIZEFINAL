<!DOCTYPE html>
<html lang="vi">
<head> 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DNY Sport ‚Äî G·ª£i √Ω size</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>


  <style>
.required {
    color: #ff4b4b;
    margin-left: 2px;
}
.popup-close {
    font-family: 'Be Vietnam Pro', sans-serif !important;
}
/* ƒê·∫∑t team-box ·ªü ch·∫ø ƒë·ªô relative ƒë·ªÉ n√∫t b√°m theo */
.team-box {
    position: relative;
}

/* N√∫t icon */
.popup-info-btn {
    position: absolute;
    top: 6px;       /* ch·ªânh cao */
    right: 6px;     /* ch·ªânh s√°t m√©p ph·∫£i */
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 5;     /* ƒë·ªÉ n·∫±m tr√™n c√πng */
}

/* V√≤ng tr√≤n ! */
.info-circle {
    width: 22px;
    height: 22px;
    border: 2px solid #ff4b4b;
    border-radius: 50%;
    color: #ff4b4b;
    font-weight: 900;
    font-size: 14px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: 0.2s ease;
}

/* Hi·ªáu ·ª©ng hover */
.popup-info-btn:hover .info-circle {
    background: #ff4b4b;
    color: #fff;
}


/* Popup overlay */
.popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9990;
}

/* Popup box */
.popup-box {
  background: #ffffff;
  width: 92%;
  max-width: 430px;
  border-radius: 18px;
  padding: 22px 26px;
  box-shadow: 0 18px 40px rgba(0,0,0,0.18);
  animation: fadeUp .25s ease;
  font-family: 'Be Vietnam Pro', sans-serif;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.popup-title {
  font-size: 22px;
  font-weight: 800;
  text-align: center;
  margin-bottom: 16px;
  color: #0b3954;
}

/* Section */
.popup-section {
  display: flex;
  gap: 12px;
  margin-bottom: 14px;
}

.popup-section .icon {
  font-size: 32px;
  line-height: 32px;
}

.popup-section h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  color: #06324b;
}

.popup-section p, .popup-section ul {
  margin: 4px 0 0;
  font-size: 14px;
  color: #0f172a;
  line-height: 1.45;
}

.popup-section ul {
  padding-left: 18px;
}

/* Close button */
.popup-close {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  font-size: 15px;
  font-weight: 900;
  border-radius: 12px;
  border: none;
  background: #1594c8;
  color: #fff;
  cursor: pointer;
}

.popup-close:hover {
  background: #0b6c9b;
}

/* Button m·ªü popup */
.guide-btn {
  background: #eef5fb;
  color: #06324b;
  padding: 10px 16px;
  border-radius: 10px;
  border: 1px solid #d7e7f2;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
}
.guide-btn:hover {
  background: #dceaf5;
}

.btn i{
  width:18px;
  height:18px;
  margin-right:6px;
}

.team-bottom-buttons{
  display:flex;
  gap:15px;
  margin-top:20px;
}

.team-bottom-buttons .btn.small{
  padding:10px 18px;
  font-size:14px;
}

.team-bottom-buttons .danger{
  background:#ff5b5b;
  color:white;
}

    .illu-wrap{
      text-align:center;
      margin-bottom:14px;
    }
    .illu-wrap img{
      max-width:300px;
      width:100%;
      height:auto;
    }

    :root{
      --bg-page:#f3f7fc;
      --pri:#1594c8;
      --pri-dark:#0b6c9b;
      --pill-bg:#f5fbff;
      --pill-border:#cbd5f5;
      --ink:#0f172a;
    }
    *{box-sizing:border-box}
body{
  font-family: 'Be Vietnam Pro', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  margin:0;
  background:var(--bg-page);
  color:var(--ink);
}

    main{
      max-width:1700px;
      margin:26px auto;
      padding:0 16px 26px;
    }
    .shell{
      background:#fff;
      border-radius:24px;
      box-shadow:0 18px 40px rgba(15,23,42,.12);
      padding:22px 22px 22px;
      display:grid;
      grid-template-columns:1.1fr 1.05fr .9fr;
      gap:18px;
    }
    @media(max-width:960px){
      .shell{grid-template-columns:1fr}
    }
    .card-left{
      border-right:1px solid #e5edf7;
      padding-right:18px;
    }
    .card-middle{
      padding:0 18px;
      border-right:1px solid #e5edf7;
    }
    @media(max-width:960px){
      .card-left,
      .card-middle{
        border-right:none;
        padding-right:0;
        padding-left:0;
      }
    }
    .card-right{}

    label{font-weight:650;font-size:14px;display:block;margin:10px 0 6px}
    input,select{
      width:100%;
      padding:12px 14px;
      border:1px solid #d7e7f2;
      border-radius:12px;
      font-size:15px;
      outline:none;
    }
    input::placeholder{color:#cbd5e1}
    input:focus,select:focus{
      border-color:var(--pri);
      box-shadow:0 0 0 3px rgba(21,148,200,.14);
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:11px 20px;
  border-radius:12px;
  border:0;
  cursor:pointer;
  font-family: 'Be Vietnam Pro', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  font-weight:900; 
  font-size:15px;
}

    .btn-primary{
      background:var(--pri);
      color:#fff;
    }
    .btn-primary:hover{background:var(--pri-dark);}
    .btn-ghost{
      background:#eef5fb;
      color:#06324b;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      background:#ecfeff;
      color:#06324b;
      font-weight:800;
      border:1px solid #c7f2ff;
    }
    .result{
      border:2px dashed #cfe8fb;
      border-radius:16px;
      padding:14px 14px 12px;
      background:#f4fbff;
      margin-top:14px;
    }
    .size-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
      height:40px;
      border-radius:12px;
      background:#0b1120;
      color:#fff;
      font-weight:900;
      font-size:18px;
      padding:0 10px;
    }
    .hint{font-size:13px;color:#0b3954;margin-top:6px}
    .error{color:#b91c1c;font-weight:800;margin-top:8px}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:14px;
    }
    th,td{
      text-align:center;
      padding:8px 6px;
      border-bottom:1px solid #eef2f7;
    }
    th{
      background:#f5fbff;
      font-weight:700;
    }
    .subtitle{
      color:#0b3954;
      font-weight:800;
      margin:4px 0 4px;
    }
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .note{
      background:#fff8e1;
      border:1px solid #fde68a;
      color:#8a6d00;
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      margin-top:10px;
    }
    tr.pick{background:#e7f5ff !important;}
    tr.heightRow{background:#fef3c7 !important;}
    .hidden{display:none}
    .score{font-size:12px;color:#475569;margin-left:6px}
    .suggestion-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media(max-width:767px){.suggestion-grid{grid-template-columns:1fr}}
    .sugg-card{
      background:#fff;
      border-radius:10px;
      border:1px solid #dbeafe;
      padding:10px 12px;
    }
    .sugg-title{
      font-size:13px;
      font-weight:800;
      color:#1e293b;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .sugg-title span.label{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .sugg-body{font-size:13px;color:#0f172a}
    .cut-main{font-weight:900;font-size:18px;color:#dc2626;margin-top:6px}
    .cut-sub{font-size:12px;color:#475569;margin-top:2px}
    .cut-cell{font-weight:800;color:#dc2626}

    .mode-tabs{
      display:flex;
      gap:10px;
      margin-bottom:12px;
    }
    .mode-pill{
      flex:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:12px 10px;
      border-radius:999px;
      border:2px solid var(--pill-border);
      background:var(--pill-bg);
      font-size:13px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.03em;
      cursor:pointer;
      color:#0f172a;
    }
    .mode-pill input{display:none;}
    .mode-pill.active{
      background:var(--pri);
      border-color:var(--pri);
      color:#fff;
    }
    .mode-pill span{pointer-events:none;}

    .team-box{
      border-radius:16px;
      border:1px dashed #d4e4f7;
      padding:10px 12px 6px;
      margin-top:14px;
      background:#f7fbff;
    }
    .team-title{font-weight:800;font-size:14px;margin-bottom:4px;color:#0b3954}
    .team-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .team-table-wrap{
      max-height:520px; /* cao h∆°n ƒë·ªÉ th·∫•y th√™m nhi·ªÅu d√≤ng */
      overflow:auto;
      margin-top:6px
    }
    .team-table-wrap table{font-size:13px}

    .btn-del{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:#475569;
    }
    .btn-del:hover{
      background:#fee2e2;
      border-color:#fecaca;
      color:#b91c1c;
    }
  </style>

  <!-- SheetJS ƒë·ªÉ ƒë·ªçc/ghi Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<!-- POPUP -->
<div id="excelGuidePopup" class="popup-overlay">
  <div class="popup-box">
    
    <h2 class="popup-title">üìò H∆∞·ªõng d·∫´n nh·∫≠p Excel</h2>

    <div class="popup-section">
      <div class="icon">üì•</div>
      <div>
        <h3>1. T·∫£i Excel m·∫´u</h3>
        <p>
          Nh·∫•n <b>‚ÄúT·∫£i Excel m·∫´u‚Äù</b> ƒë·ªÉ l·∫•y file chu·∫©n.  
          Trong file, b·∫°n ch·ªâ c·∫ßn ƒëi·ªÅn:<br>
        <ul>
          <li>T√™n & S·ªë √°o, ƒê·ªëi t∆∞·ª£ng, S·ªë ƒëo t∆∞∆°ng ·ª©ng  
          (D√†i √°o ‚Äì Ng·ª±c ‚Äì Tay ho·∫∑c Cao ‚Äì N·∫∑ng)</li>
        </ul>
        </p>
      </div>
    </div>

    <div class="popup-section">
      <div class="icon">üì§</div>
      <div>
        <h3>2. Nh·∫≠p t·ª´ Excel</h3>
        <p>
          Nh·∫•n <b>‚ÄúNh·∫≠p t·ª´ Excel‚Äù</b> ‚Üí ch·ªçn file v·ª´a ƒëi·ªÅn.<br>

          H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông:<br>
        </p>
        <ul>
         <li> ƒê·ªçc d·ªØ li·ªáu  ‚Üí  G·ª£i √Ω size  ‚Üí  Th√™m v√†o danh s√°ch ƒë·ªôi</li>
        </ul>
      </div>
    </div>

    <div class="popup-section">
      <div class="icon">üíõ</div>
      <div>
        <h3>L∆∞u √Ω nh·ªè</h3>
        <ul>
          <li>Gi·ªØ nguy√™n t√™n c√°c c·ªôt trong file m·∫´u.</li>
          <li>ƒêi·ªÅn ƒë·ªß th√¥ng tin quan tr·ªçng.</li>
          <li>Ch·ªçn ƒë√∫ng ch·∫ø ƒë·ªô: <b>Ch·ªçn theo th√¥ng s·ªë √°o</b> ho·∫∑c <b>Ch·ªçn theo chi·ªÅu cao & C√¢n n·∫∑ng.</b></li>
        </ul>
      </div>
    </div>

    <button class="popup-close" onclick="closeGuide()">ƒê√É HI·ªÇU</button>
  </div>
</div>

<main>
  <div class="shell">
    <!-- C·ªòT 1: FORM -->
    <section class="card-left">
      <div class="mode-tabs">
        <label class="mode-pill active" id="pillMeasure">
          <input type="radio" name="mode" value="measure" checked onchange="switchMode()">
<div style="text-align:center;">
    <span>Ch·ªçn theo th√¥ng s·ªë √°o</span>
</div>

        </label>
        <label class="mode-pill" id="pillBody">
          <input type="radio" name="mode" value="body" onchange="switchMode()">
          <div style="text-align:center;">
            Ch·ªçn theo chi·ªÅu cao<br>
            &amp; c√¢n n·∫∑ng
          </div>
        </label>
      </div>

      <div class="row">
        <div>
          <label for="gender">ƒê·ªëi t∆∞·ª£ng</label>
          <select id="gender" onchange="toggleTables()">
            <option value="male" selected>Nam</option>
            <option value="female">N·ªØ</option>
            <option value="kids">Tr·∫ª em</option>
          </select>
        </div>
        <div>
          <label for="sport">M√¥n th·ªÉ thao (tu·ª≥ ch·ªçn)</label>
          <select id="sport">
            <option value="football" selected>B√≥ng ƒë√°</option>
            <option value="volleyball">B√≥ng chuy·ªÅn</option>
            <option value="basketball">B√≥ng r·ªï</option>
            <option value="baseball">B√≥ng ch√†y</option>
            <option value="futsal">Futsal</option>
            <option value="rugby">B√≥ng b·∫ßu d·ª•c</option>
            <option value="badminton">C·∫ßu l√¥ng</option>
            <option value="pickleball">Pickleball</option>
            <option value="cycling">Xe ƒë·∫°p</option>
            <option value="running">Ch·∫°y b·ªô</option>
            <option value="training">Gym/Training</option>
          </select>
        </div>
      </div>

      <!-- MODE: TH√îNG S·ªê √ÅO -->
      <div id="measureBlock" style="margin-top:10px">
        <div class="row">
          <div>
            <label for="len">D√†i √°o (cm) <span class="required">*</span></label>
            <input id="len" inputmode="decimal" placeholder="VD: 70">
          </div>
          <div>
            <label for="chest">Ngang ng·ª±c √°o (cm) <span class="required">*</span></label>
            <input id="chest" inputmode="decimal" placeholder="VD: 52">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="sleeve">D√†i tay (cm)</label>
            <input id="sleeve" inputmode="decimal" placeholder="VD: 22">
          </div>
        </div>
      </div>

      <!-- MODE: CAO & C√ÇN N·∫∂NG -->
      <div id="bodyBlock" class="hidden" style="margin-top:10px">
<div class="row">
  <div>
    <label for="height">Chi·ªÅu cao (cm) <span class="required">*</span></label>
    <input id="height" inputmode="decimal" placeholder="VD: 172">
  </div>
  <div>
    <label for="weight">C√¢n n·∫∑ng (kg) <span class="required">*</span></label>
    <input id="weight" inputmode="decimal" placeholder="VD: 68">
  </div>
</div>

        <div class="hint">
          H·ªá th·ªëng d√πng chi·ªÅu cao &amp; c√¢n n·∫∑ng ƒë·ªÉ ch·∫•m ƒëi·ªÉm m·ªÅm (soft score) theo b·∫£ng size, c√≥ x√©t l·ªách size v√† m√¥n th·ªÉ thao.
        </div>
      </div>

      <!-- T√äN & S·ªê √ÅO -->
<div class="row" style="margin-top:10px">
  <div>
    <label for="playerName">T√™n c·∫ßu th·ªß</label>
    <input id="playerName" placeholder="VD: Nguy·ªÖn VƒÉn A">
  </div>

  <div>
    <label for="playerNumber">S·ªë √°o (tu·ª≥ ch·ªçn)</label>
    <input id="playerNumber" inputmode="numeric" placeholder="VD: 10">
  </div>
</div>


      <!-- N√öT -->
      <div class="flex" style="margin-top:14px">
        <button class="btn btn-primary" type="button" onclick="handleSuggest()">
          G·ª¢I √ù SIZE
        </button>
        <button class="btn btn-ghost" type="button" onclick="clearAll()">Xo√°</button>
        <span id="adultSizes" class="pill">XS ‚Ä¢ S ‚Ä¢ M ‚Ä¢ L ‚Ä¢ XL ‚Ä¢ XXL ‚Ä¢ 3XL ‚Ä¢ 4XL ‚Ä¢ 5XL ‚Ä¢ 6XL ‚Ä¢ 7XL</span>
        <span id="kidSizes" class="pill hidden">1 ‚Ä¢ 3 ‚Ä¢ 5 ‚Ä¢ 7 ‚Ä¢ 9 ‚Ä¢ 11 ‚Ä¢ 13</span>
      </div>

      <div id="kidNote" class="note hidden">
        Tr·∫ª em: c√≥ th·ªÉ d√πng c·∫£ 2 c√°ch. B·∫£ng size tham chi·∫øu ch·ªß y·∫øu theo <b>c√¢n n·∫∑ng &amp; ƒë·ªô tu·ªïi</b>.
      </div>

      <div id="err" class="error" style="display:none"></div>
      <div id="result" class="result" style="display:none"></div>
    </section>

    <!-- C·ªòT 2: B·∫¢NG SIZE + MINH HO·∫† -->
    <aside class="card-middle">
      <div class="illu-wrap">
        <img id="illuImg" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOVlza5Gb9QHNpItToKxqrQi6PgJ736i7ysHmmxXxX0sJC2M1YkiCKPuG_nySLYzCKq_FtNlgoDxPyegXTHqTBDdBudeff-QQiAnr62PLmzpc4Pizy8gWt4pgXIBShNqyApgo-lalLh2co2Uqjc6ReZO2pJyMSQevfWOdz3sVAPhD5J3NEi46Zp6rvfBE/s16000/MINH%20HOA.png" alt="Minh h·ªça ƒëo √°o">
      </div>

      <div id="maleTblWrap">
        <style>
          .subtitle {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
          }
        </style>

        <div class="subtitle" style="font-size:20px;">B·∫¢NG TH√îNG S·ªê NAM</div>
        <table aria-label="B·∫£ng size Nam">
          <thead>
            <tr>
              <th>Size</th>
              <th>C√¢n n·∫∑ng (kg)</th>
              <th>Chi·ªÅu cao (cm)</th>
              <th>D√†i √°o</th>
              <th>Ngang ng·ª±c</th>
              <th>D√†i tay</th>
            </tr>
          </thead>
          <tbody id="tableBodyMale"></tbody>
        </table>
      </div>

      <div id="femaleTblWrap" class="hidden">
        <div class="subtitle" style="font-size:20px;">B·∫¢NG TH√îNG S·ªê N·ªÆ</div>
        <table aria-label="B·∫£ng size N·ªØ">
          <thead>
            <tr>
              <th>Size</th>
              <th>Kg tham kh·∫£o</th>
              <th>Chi·ªÅu cao (cm)</th>
              <th>D√†i √°o</th>
              <th>Ngang ng·ª±c</th>
              <th>Ngang eo</th>
              <th>D√†i tay</th>
            </tr>
          </thead>
          <tbody id="tableBodyFemale"></tbody>
        </table>
      </div>

      <div id="kidTblWrap" class="hidden">
        <div class="subtitle" style="font-size:20px;">B·∫¢NG TH√îNG S·ªê TR·∫∫ EM</div>
        <table aria-label="B·∫£ng size Tr·∫ª em">
          <thead>
            <tr>
              <th>Size</th>
              <th>Kg tham kh·∫£o</th>
              <th>Tu·ªïi</th>
              <th>D√†i √°o</th>
              <th>Ngang ng·ª±c</th>
              <th>D√†i tay</th>
            </tr>
          </thead>
          <tbody id="tableBodyKid"></tbody>
        </table>
      </div>

      <p class="hint" style="margin-top:6px">
        D√≤ng ƒë∆∞·ª£c ch·ªçn s·∫Ω ƒë∆∞·ª£c highlight trong b·∫£ng (theo size ƒë·ªÅ xu·∫•t). V·ªõi cao/c√¢n n·∫∑ng: th√™m highlight v√†ng cho size theo chi·ªÅu cao.
      </p>
    </aside>

    <!-- C·ªòT 3: DANH S√ÅCH ƒê·ªòI -->
    <aside class="card-right">
      <div class="team-box">
<button class="popup-info-btn" onclick="openGuide()">
  <span class="info-circle">!</span>
</button>
<div class="team-title" style="font-size:20px;">DANH S√ÅCH ƒê·ªòI</div>
        <div class="hint">
          M·ªói l·∫ßn b·∫•m <b>‚ÄúG·ª£i √Ω size‚Äù</b>, h·ªá th·ªëng s·∫Ω t·ª± th√™m 1 d√≤ng v√†o b·∫£ng.
        </div>
        <div class="team-actions">
          <button class="btn btn-ghost" type="button" onclick="downloadExcelTemplate()">T·∫£i Excel m·∫´u <i data-lucide="file-down" style="width:20px; height:20px;"></i></button>
          <button class="btn btn-ghost" type="button" onclick="document.getElementById('importExcel').click()">Nh·∫≠p t·ª´ Excel <i data-lucide="file-up" style="width:20px; height:20px;"></i></button>
          <input
            type="file"
            id="importExcel"
            accept=".xlsx,.xls"
            style="display:none"
            onchange="handleImportExcel(event)">
        </div>

        <div class="team-table-wrap">
          <table>
            <thead id="teamHead"></thead>
            <tbody id="teamTableBody"></tbody>
          </table>
        </div>  <!-- ƒë√≥ng .team-table-wrap -->

<div class="team-bottom-buttons">
  <button class="btn small danger" onclick="clearTeam()">X√≥a danh s√°ch ƒë·ªôi</button>

  <button class="btn small" onclick="downloadCSV()">
    T·∫£i v·ªÅ <i data-lucide="download" style="width:20px; height:20px;"></i>
  </button>

  <button class="btn small" onclick="shareTeam()">
    Chia s·∫ª <i data-lucide="share-2" style="width:20px; height:20px;"></i>
  </button>
</div>


      </div>
    </aside>
  </div>
</main>

<script>
  /* ====== DATA ====== */
  const MALE=[
    {code:"XS",w:[45,50],h:[140,150],len:58,chest:44,sleeve:20},
    {code:"S",w:[50,55],h:[145,155],len:61,chest:46,sleeve:21},
    {code:"M",w:[55,60],h:[155,160],len:64,chest:48,sleeve:22},
    {code:"L",w:[60,70],h:[160,170],len:67,chest:50,sleeve:23},
    {code:"XL",w:[70,80],h:[170,180],len:70,chest:52,sleeve:24},
    {code:"XXL",w:[80,90],h:[180,190],len:72,chest:54,sleeve:25},
    {code:"3XL",w:[90,100],h:[185,195],len:73,chest:56,sleeve:26},
    {code:"4XL",w:[100,110],h:[190,200],len:74,chest:58,sleeve:27},
    {code:"5XL",w:[110,120],h:[195,205],len:75.5,chest:60,sleeve:27},
    {code:"6XL",w:[120,130],h:[200,210],len:77,chest:62,sleeve:27},
    {code:"7XL",w:[130,140],h:[205,215],len:77.5,chest:64,sleeve:27},
  ];
  const FEMALE=[
    {code:"XS",w:[45,55],h:[135,145],len:52,chest:42,waist:39,sleeve:15},
    {code:"S",w:[50,55],h:[145,155],len:55.5,chest:44,waist:41,sleeve:16},
    {code:"M",w:[55,60],h:[155,160],len:59,chest:46,waist:43,sleeve:17},
    {code:"L",w:[60,70],h:[160,170],len:62,chest:48,waist:45,sleeve:18},
    {code:"XL",w:[70,80],h:[170,180],len:65,chest:50,waist:47,sleeve:19},
    {code:"XXL",w:[80,90],h:[180,190],len:68,chest:52,waist:49,sleeve:20},
    {code:"3XL",w:[90,100],h:[185,195],len:71,chest:54,waist:51,sleeve:21},
    {code:"4XL",w:[100,110],h:[190,200],len:74,chest:56,waist:53,sleeve:22},
    {code:"5XL",w:[110,120],h:[195,205],len:77,chest:58,waist:55,sleeve:23},
    {code:"6XL",w:[120,130],h:[200,210],len:80,chest:60,waist:57,sleeve:24},
  ];
  const KIDS=[
    {code:"1",w:[10,15],age:"1‚Äì2",len:42,chest:32,sleeve:12},
    {code:"3",w:[15,20],age:"3‚Äì4",len:44,chest:34,sleeve:13},
    {code:"5",w:[20,25],age:"5‚Äì6",len:46.5,chest:36,sleeve:14},
    {code:"7",w:[25,30],age:"7‚Äì8",len:45.5,chest:38,sleeve:15},
    {code:"9",w:[30,35],age:"9‚Äì10",len:52,chest:40,sleeve:16},
    {code:"11",w:[35,40],age:"11‚Äì12",len:55,chest:42,sleeve:17},
    {code:"13",w:[40,45],age:"13‚Äì14",len:58,chest:44,sleeve:18},
  ];

  const $ = id => document.getElementById(id);

  /* ====== RENDER SIZE TABLES ====== */
  function renderMale(){
    $("tableBodyMale").innerHTML = MALE.map(r=>`
      <tr>
        <td><b>${r.code}</b></td>
        <td>${r.w[0]}‚Äì${r.w[1]}</td>
        <td>${r.h[0]}‚Äì${r.h[1]}</td>
        <td>${r.len}</td>
        <td>${r.chest}</td>
        <td>${r.sleeve}</td>
      </tr>`).join("");
  }
  function renderFemale(){
    $("tableBodyFemale").innerHTML = FEMALE.map(r=>`
      <tr>
        <td><b>${r.code}</b></td>
        <td>${r.w[0]}‚Äì${r.w[1]}</td>
        <td>${r.h[0]}‚Äì${r.h[1]}</td>
        <td>${r.len}</td>
        <td>${r.chest}</td>
        <td>${r.waist}</td>
        <td>${r.sleeve}</td>
      </tr>`).join("");
  }
  function renderKids(){
    $("tableBodyKid").innerHTML = KIDS.map(r=>`
      <tr>
        <td><b>${r.code}</b></td>
        <td>${r.w[0]}‚Äì${r.w[1]}</td>
        <td>${r.age}</td>
        <td>${r.len}</td>
        <td>${r.chest}</td>
        <td>${r.sleeve}</td>
      </tr>`).join("");
  }
  renderMale(); renderFemale(); renderKids();

  /* ====== UTILS ====== */
function parseNum(x){
  if (x == null) return NaN;
  x = String(x)
        .replace(/[^\d,\.\-]/g, "")
        .replace(",", ".")
        .trim();
  if (x === "") return NaN;   // <‚Äì th√™m d√≤ng n√†y
  return Number(x);
}

  function toggleTables(){
    const g = $("gender").value;
    $("maleTblWrap").classList.toggle("hidden", g!=="male");
    $("femaleTblWrap").classList.toggle("hidden", g!=="female");
    $("kidTblWrap").classList.toggle("hidden", g!=="kids");
    $("kidNote").classList.toggle("hidden", g!=="kids");
    $("adultSizes").classList.toggle("hidden", g==="kids");
    $("kidSizes").classList.toggle("hidden", g!=="kids");

    const illu = $("illuImg");
    if(g === "male") illu.src = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOVlza5Gb9QHNpItToKxqrQi6PgJ736i7ysHmmxXxX0sJC2M1YkiCKPuG_nySLYzCKq_FtNlgoDxPyegXTHqTBDdBudeff-QQiAnr62PLmzpc4Pizy8gWt4pgXIBShNqyApgo-lalLh2co2Uqjc6ReZO2pJyMSQevfWOdz3sVAPhD5J3NEi46Zp6rvfBE/s16000/MINH%20HOA.png";
    else if(g === "female") illu.src = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOVlza5Gb9QHNpItToKxqrQi6PgJ736i7ysHmmxXxX0sJC2M1YkiCKPuG_nySLYzCKq_FtNlgoDxPyegXTHqTBDdBudeff-QQiAnr62PLmzpc4Pizy8gWt4pgXIBShNqyApgo-lalLh2co2Uqjc6ReZO2pJyMSQevfWOdz3sVAPhD5J3NEi46Zp6rvfBE/s16000/MINH%20HOA.png";
    else illu.src = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOVlza5Gb9QHNpItToKxqrQi6PgJ736i7ysHmmxXxX0sJC2M1YkiCKPuG_nySLYzCKq_FtNlgoDxPyegXTHqTBDdBudeff-QQiAnr62PLmzpc4Pizy8gWt4pgXIBShNqyApgo-lalLh2co2Uqjc6ReZO2pJyMSQevfWOdz3sVAPhD5J3NEi46Zp6rvfBE/s16000/MINH%20HOA.png";

    clearAll();
  }
  function clearHighlight(){
    document.querySelectorAll("tbody tr").forEach(tr=>tr.classList.remove("pick","heightRow"));
  }

  function switchMode(){
    const mode = document.querySelector('input[name="mode"]:checked').value;
    $("measureBlock").classList.toggle("hidden", mode!=="measure");
    $("bodyBlock").classList.toggle("hidden", mode!=="body");
    $("pillMeasure").classList.toggle("active", mode==="measure");
    $("pillBody").classList.toggle("active", mode==="body");
    $("err").style.display="none";
    $("result").style.display="none";
    renderTeamTable();
  }

  /* ====== TH√îNG S·ªê √ÅO ‚Äî LOGIC 1 NG∆Ø·ªúI ====== */
  function calcSuggestions(len, chest, sleeve, table){
    let bestOverall={idx:-1,score:Infinity};
    let bestChest={idx:-1,score:Infinity};

    table.forEach((s,i)=>{
      let chestScore = (!Number.isNaN(chest) && typeof s.chest==="number")
        ? Math.pow(chest - s.chest,2) : NaN;
      let lenScore   = (!Number.isNaN(len) && typeof s.len==="number")
        ? Math.pow(len - s.len,2) : NaN;
      let sleeveScore= (!Number.isNaN(sleeve) && typeof s.sleeve==="number")
        ? Math.pow(sleeve - s.sleeve,2) : NaN;

      let scoreOverall=0, hasAny=false;
      if(!Number.isNaN(chestScore)){scoreOverall+=1.0*chestScore; hasAny=true;}
      if(!Number.isNaN(lenScore)){scoreOverall+=1.0*lenScore; hasAny=true;}
      if(!Number.isNaN(sleeveScore)){scoreOverall+=0.2*sleeveScore; hasAny=true;}
      if(!hasAny) return;
      scoreOverall += 0.01*Math.pow(i - table.length/2,2);

      if(scoreOverall<bestOverall.score){bestOverall={idx:i,score:scoreOverall};}
      if(!Number.isNaN(chestScore) && chestScore<bestChest.score){bestChest={idx:i,score:chestScore};}
    });

    return {
      overall: bestOverall.idx>=0 ? bestOverall : null,
      chest: bestChest.idx>=0 ? bestChest : null,
    };
  }

  function renderMeasureResult(len, chest, sleeve, table, selector, whoLabel){
    const err = $("err"), out = $("result");

    if (Number.isNaN(len) || Number.isNaN(chest)) {
      err.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß D√†i √°o v√† Ngang ng·ª±c.";
      err.style.display = "block";
      out.style.display = "none";
      return false;
    }

    const sugg = calcSuggestions(len, chest, sleeve, table);
    if(!sugg.overall){
      err.textContent = "Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size.";
      err.style.display = "block";
      out.style.display = "none";
      return false;
    }

    const overallIdx = sugg.overall.idx;
    const chestIdx   = sugg.chest?.idx ?? null;

    clearHighlight();
    const tb = document.querySelector(selector);
    if(tb && tb.children[overallIdx]) tb.children[overallIdx].classList.add("pick");

    const pOverall = table[overallIdx];
    const pChest   = chestIdx!=null ? table[chestIdx] : null;

    const user = { len, chest, sleeve };

    let cutDelta = null;
    if(pChest && !Number.isNaN(len) && typeof pChest.len==="number"){
      cutDelta = pChest.len - len;
    }

    let cutMainText = "";
    let cutSubText = "";
    if(pChest && cutDelta !== null){
      if(Math.abs(cutDelta) <= 1){
        cutMainText = "Kh√¥ng c·∫ßn c·∫Øt/tƒÉng lai";
        cutSubText = "D√†i √°o size tu·ª≥ ch·ªânh g·∫ßn gi·ªëng √°o m·∫´u.";
      } else if(cutDelta > 1){
        cutMainText = `C·∫Øt lai ${cutDelta.toFixed(1)}cm`;
        cutSubText = `√Åo chu·∫©n size ${pChest.code} d√†i h∆°n √°o m·∫´u, c·∫Øt b·ªõt ƒë·ªÉ ra ƒë·ªô d√†i t∆∞∆°ng ƒë∆∞∆°ng.`;
      } else {
        cutMainText = `TƒÉng lai ~${Math.abs(cutDelta).toFixed(1)}cm`;
        cutSubText = `Size ${pChest.code} ng·∫Øn h∆°n √°o m·∫´u, c·∫ßn may d√†i h∆°n/tƒÉng lai n·∫øu mu·ªën gi·ªëng √°o m·∫´u.`;
      }
    }

    const rowOverall = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t</b>
        </div>
        <div class="sugg-body">
          <div>Size ƒë·ªÅ xu·∫•t: <span class="size-badge">${pOverall.code}</span></div>
          <div class="hint score">
            ƒêi·ªÉm kh·ªõp t·ªïng th·ªÉ (d√†i √°o + ngang ng·ª±c + tay): <b>${sugg.overall.score.toFixed(1)}</b> (c√†ng th·∫•p c√†ng t·ªët)
          </div>
        </div>
      </div>
    `;

    const rowChestCut = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">2</span> <b>Size tu·ª≥ ch·ªânh</b>
        </div>
        <div class="sugg-body">
          ${
            pChest
            ? `
              <div>Size tu·ª≥ ch·ªânh: <span class="size-badge">${pChest.code}</span></div>
              ${
                cutMainText
                  ? `<div class="cut-main">${cutMainText}</div>
                     <div class="cut-sub">${cutSubText}</div>`
                  : `<div class="hint">C·∫ßn nh·∫≠p d√†i √°o ƒë·ªÉ g·ª£i √Ω c·∫Øt/tƒÉng lai.</div>`
              }
            `
            : "C·∫ßn c√≥ s·ªë ƒëo ngang ng·ª±c (v√† t·ªët nh·∫•t c√≥ th√™m d√†i √°o) ƒë·ªÉ ƒë∆∞a g·ª£i √Ω Size tu·ª≥ ch·ªânh."
          }
        </div>
      </div>
    `;

    const compareTable = `
      <div class="subtitle" style="margin-top:12px">So s√°nh s·ªë ƒëo √°o (theo Size ƒë·ªÅ xu·∫•t &amp; Size tu·ª≥ ch·ªânh)</div>
      <table style="margin-top:6px;font-size:13px">
        <thead>
          <tr>
            <th></th>
            <th>√Åo kh√°ch ƒëo</th>
            <th>Chu·∫©n size ${pOverall.code}</th>
            <th>${pChest ? "Size " + pChest.code + " tu·ª≥ ch·ªânh" : "Size tu·ª≥ ch·ªânh"}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>D√†i √°o</b></td>
            <td>${Number.isNaN(user.len) ? "‚Äî" : user.len.toFixed(1)+"cm"}</td>
            <td>${typeof pOverall.len==="number" ? pOverall.len+"cm" : "‚Äî"}</td>
            <td>
              ${
                pChest && typeof pChest.len==="number"
                ? (() => {
                    const base = pChest.len.toFixed(1)+"cm";
                    if(cutDelta===null || Math.abs(cutDelta)<=1) return base;
                    const adj = -cutDelta;
                    const sign = adj>0 ? "+" : "";
                    return base+`<br><span class="cut-cell">${sign}${adj.toFixed(1)}cm</span>`;
                  })()
                : "‚Äî"
              }
            </td>
          </tr>
          <tr>
            <td><b>Ngang ng·ª±c</b></td>
            <td>${Number.isNaN(user.chest) ? "‚Äî" : user.chest.toFixed(1)+"cm"}</td>
            <td>${typeof pOverall.chest==="number" ? pOverall.chest+"cm" : "‚Äî"}</td>
            <td>${pChest && typeof pChest.chest==="number" ? pChest.chest+"cm" : "‚Äî"}</td>
          </tr>
          <tr>
            <td><b>D√†i tay</b></td>
            <td>${Number.isNaN(user.sleeve) ? "‚Äî" : user.sleeve.toFixed(1)+"cm"}</td>
            <td>${typeof pOverall.sleeve==="number" ? pOverall.sleeve+"cm" : "‚Äî"}</td>
            <td>${pChest && typeof pChest.sleeve==="number" ? pChest.sleeve+"cm" : "‚Äî"}</td>
          </tr>
        </tbody>
      </table>
    `;

    err.style.display="none";
    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω (${whoLabel}) ‚Äî 2 size + b·∫£ng so s√°nh s·ªë ƒëo.</div>
      <div class="suggestion-grid">
        ${rowOverall}
        ${rowChestCut}
      </div>
      ${compareTable}
    `;
    return true;
  }

  function renderKidsMeasure(len, chest, sleeve){
    const err=$("err"), out=$("result");

    if(Number.isNaN(len) && Number.isNaN(chest) && Number.isNaN(sleeve)){
      err.textContent="Nh·∫≠p √≠t nh·∫•t 1 trong 3 s·ªë ƒëo √°o c·ªßa b√©.";
      err.style.display="block"; out.style.display="none"; return false;
    }

    const sugg = calcSuggestions(len, chest, sleeve, KIDS);
    if(!sugg.overall){
      err.textContent="Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size.";
      err.style.display="block"; out.style.display="none"; return false;
    }

    const overallIdx = sugg.overall.idx;
    const chestIdx   = sugg.chest?.idx ?? null;

    clearHighlight();
    const tb = document.querySelector("#tableBodyKid");
    if(tb && tb.children[overallIdx]) tb.children[overallIdx].classList.add("pick");

    const pOverall = KIDS[overallIdx];
    const pChest   = chestIdx!=null ? KIDS[chestIdx] : null;
    const user = { len, chest, sleeve };

    let cutDelta=null;
    if(pChest && !Number.isNaN(len) && typeof pChest.len==="number"){
      cutDelta = pChest.len - len;
    }
    let cutMainText="", cutSubText="";
    if(pChest && cutDelta!==null){
      if(Math.abs(cutDelta)<=1){
        cutMainText="Kh√¥ng c·∫ßn c·∫Øt/tƒÉng lai";
        cutSubText="D√†i √°o size tu·ª≥ ch·ªânh g·∫ßn gi·ªëng √°o b√© ƒëang m·∫∑c.";
      } else if(cutDelta>1){
        cutMainText=`C·∫Øt lai ${cutDelta.toFixed(1)}cm`;
        cutSubText=`√Åo chu·∫©n size ${pChest.code} d√†i h∆°n √°o m·∫´u, c√≥ th·ªÉ c·∫Øt b·ªõt cho b√©.`;
      } else {
        cutMainText=`TƒÉng lai ~${Math.abs(cutDelta).toFixed(1)}cm`;
        cutSubText=`Size ${pChest.code} ng·∫Øn h∆°n √°o m·∫´u, c·∫ßn may d√†i h∆°n n·∫øu ph·ª• huynh mu·ªën gi·ªØ ƒë·ªô d√†i.`;
      }
    }

    const rowOverall = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t</b>
        </div>
        <div class="sugg-body">
          <div>Size ƒë·ªÅ xu·∫•t: <span class="size-badge">${pOverall.code}</span></div>
          <div class="hint score">ƒêi·ªÉm kh·ªõp t·ªïng th·ªÉ: <b>${sugg.overall.score.toFixed(1)}</b></div>
        </div>
      </div>
    `;
    const rowChestCut = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">2</span> <b>Size tu·ª≥ ch·ªânh</b></div>
        <div class="sugg-body">
          ${
            pChest
            ? `
              <div>Size tu·ª≥ ch·ªânh: <span class="size-badge">${pChest.code}</span></div>
              ${
                cutMainText
                  ? `<div class="cut-main">${cutMainText}</div>
                     <div class="cut-sub">${cutSubText}</div>`
                  : `<div class="hint">C·∫ßn nh·∫≠p d√†i √°o ƒë·ªÉ g·ª£i √Ω c·∫Øt/tƒÉng lai.</div>`
              }
            `
            : "C·∫ßn c√≥ s·ªë ƒëo ngang ng·ª±c (v√† t·ªët nh·∫•t c√≥ th√™m d√†i √°o) ƒë·ªÉ g·ª£i √Ω Size tu·ª≥ ch·ªânh."
          }
        </div>
      </div>
    `;
    const compareTable = `
      <div class="subtitle" style="margin-top:12px">So s√°nh s·ªë ƒëo √°o (theo Size ƒë·ªÅ xu·∫•t &amp; Size tu·ª≥ ch·ªânh)</div>
      <table style="margin-top:6px;font-size:13px">
        <thead>
          <tr>
            <th></th>
            <th>√Åo kh√°ch ƒëo</th>
            <th>Chu·∫©n size ${pOverall.code}</th>
            <th>${pChest ? "Size " + pChest.code + " tu·ª≥ ch·ªânh" : "Size tu·ª≥ ch·ªânh"}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>D√†i √°o</b></td>
            <td>${Number.isNaN(user.len) ? "‚Äî" : user.len.toFixed(1)+"cm"}</td>
            <td>${pOverall.len}cm</td>
            <td>
              ${
                pChest
                ? (() => {
                    const base = pChest.len.toFixed(1)+"cm";
                    if(cutDelta===null || Math.abs(cutDelta)<=1) return base;
                    const adj = -cutDelta;
                    const sign = adj>0 ? "+" : "";
                    return base+`<br><span class="cut-cell">${sign}${adj.toFixed(1)}cm</span>`;
                  })()
                : "‚Äî"
              }
            </td>
          </tr>
          <tr>
            <td><b>Ngang ng·ª±c</b></td>
            <td>${Number.isNaN(user.chest) ? "‚Äî" : user.chest.toFixed(1)+"cm"}</td>
            <td>${pOverall.chest}cm</td>
            <td>${pChest ? pChest.chest+"cm" : "‚Äî"}</td>
          </tr>
          <tr>
            <td><b>D√†i tay</b></td>
            <td>${Number.isNaN(user.sleeve) ? "‚Äî" : user.sleeve.toFixed(1)+"cm"}</td>
            <td>${pOverall.sleeve}cm</td>
            <td>${pChest ? pChest.sleeve+"cm" : "‚Äî"}</td>
          </tr>
        </tbody>
      </table>
    `;

    err.style.display="none";
    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω (Tr·∫ª em) ‚Äî 2 size + b·∫£ng so s√°nh s·ªë ƒëo.</div>
      <div class="suggestion-grid">
        ${rowOverall}
        ${rowChestCut}
      </div>
      ${compareTable}
    `;
    return true;
  }

  function suggestByMeasure(){
    const g = $("gender").value;
    const len = parseNum($("len").value);
    const chest = parseNum($("chest").value);
    const sleeve = parseNum($("sleeve").value);

    if(g==="kids"){
      return renderKidsMeasure(len, chest, sleeve);
    } else if(g==="male"){
      return renderMeasureResult(len, chest, sleeve, MALE, "#tableBodyMale", "Nam");
    } else {
      return renderMeasureResult(len, chest, sleeve, FEMALE, "#tableBodyFemale", "N·ªØ");
    }
  }

  /* ====== CAO / C√ÇN N·∫∂NG ====== */
  function inRange(v,[a,b]){ return v>=a && v<=b; }
  function distToRange(v,[a,b]){ if(v<a) return a-v; if(v>b) return v-b; return 0; }
  function width(range){ const [a,b]=range; return Math.max(1e-9, b-a); }

  const SPORT_ADJ = {
    football:0,
    volleyball:0,
    pickleball:0,
    training:0,
    basketball:0.15,
    baseball:0.15,
    futsal:0.15,
    rugby:0.15,
    badminton:-0.15,
    cycling:-0.15,
    running:-0.15
  };

  function softScore(size, w, h, alpha=0.65, beta=0.35, sportBias=0){
    const dw = distToRange(w, size.w) / width(size.w);
    const dh = distToRange(h, size.h) / width(size.h);
    let s = alpha*dw + beta*dh;
    s -= sportBias;
    return s;
  }
  function findNearestByRange(value, table, key){
    let bestIdx=-1, bestDist=Infinity;
    table.forEach((s,i)=>{
      const d = distToRange(value, s[key]);
      if(d<bestDist){bestDist=d; bestIdx=i;}
    });
    return bestIdx;
  }

  function renderBodyResultAdult(h, w, table, selector, whoLabel){
    const err=$("err"), out=$("result");
    const idxH = findNearestByRange(h, table, "h");
    const idxW = findNearestByRange(w, table, "w");

    if(idxH<0 || idxW<0){
      err.textContent="Chi·ªÅu cao ho·∫∑c c√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tham chi·∫øu.";
      err.style.display="block"; out.style.display="none"; return false;
    }

    const diff = idxH - idxW;
    const absDiff = Math.abs(diff);

    if(absDiff>=3){
      err.textContent="Chi·ªÅu cao v√† c√¢n n·∫∑ng l·ªách qu√° nhi·ªÅu (tr√™n 2 size). N√™n t∆∞ v·∫•n tr·ª±c ti·∫øp.";
      err.style.display="block"; out.style.display="none"; return false;
    }

    const sport = $("sport").value;
    const sportBias = SPORT_ADJ[sport] || 0;

    let bestSoftIdx=-1, bestSoft=Infinity;
    table.forEach((s,i)=>{
      const sc = softScore(s, w, h, 0.65, 0.35, sportBias);
      if(sc<bestSoft){ bestSoft=sc; bestSoftIdx=i; }
    });

    let pickIdx = bestSoftIdx;
    let note="", adjBadge="";

    if(absDiff===0){
      note = `Chi·ªÅu cao &amp; c√¢n n·∫∑ng c√πng nh√≥m size.`;
    } else if(absDiff===1){
      if(diff>0){
        note = `B·∫°n h∆°i cao so v·ªõi c√¢n n·∫∑ng (nghi√™ng l√™n 1 size theo chi·ªÅu cao).`;
      } else {
        note = `B·∫°n h∆°i n·∫∑ng so v·ªõi chi·ªÅu cao (nghi√™ng xu·ªëng 1 size theo c√¢n n·∫∑ng).`;
      }
    } else if(absDiff===2){
      if(diff>0){
        pickIdx = idxH;
        note = `Cao ‚Äì g·∫ßy (l·ªách 2 size): ∆∞u ti√™n size theo chi·ªÅu cao ${table[idxH].code}.`;
      } else {
        pickIdx = idxW;
        note = `Th·∫•p ‚Äì n·∫∑ng (l·ªách 2 size): ∆∞u ti√™n size theo c√¢n n·∫∑ng ${table[idxW].code}.`;
      }
      adjBadge = `<span class="hint" style="margin-left:8px;font-size:11px">(ƒëi·ªÅu ch·ªânh theo l·ªách 2 size)</span>`;
    }

    clearHighlight();
    const tb = document.querySelector(selector);
    if(tb){
      if(tb.children[pickIdx]) tb.children[pickIdx].classList.add("pick");
      if(tb.children[idxH]) tb.children[idxH].classList.add("heightRow");
    }

    const pick = table[pickIdx];

    let laiText = "Kh√¥ng c√≥ g·ª£i √Ω lai ƒë·∫∑c bi·ªát.";
    let laiExplain = "";
    const lenPick = pick.len;
    const lenHeight = table[idxH].len;
    if(typeof lenPick==="number" && typeof lenHeight==="number"){
      const delta = lenHeight - lenPick;
      if(Math.abs(delta)<=0.5){
        laiText = "Kh√¥ng c·∫ßn c·∫Øt/tƒÉng lai.";
        laiExplain = "D√†i √°o size ƒë·ªÅ xu·∫•t g·∫ßn gi·ªëng d√†i √°o chu·∫©n theo chi·ªÅu cao.";
      } else if(delta>0){
        laiText = `TƒÉng lai ~${delta.toFixed(1)}cm`;
        laiExplain = `N·∫øu mu·ªën form d√†i theo chi·ªÅu cao (${table[idxH].code}), c√≥ th·ªÉ may d√†i th√™m so v·ªõi size ${pick.code}.`;
      } else {
        laiText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
        laiExplain = `Chi·ªÅu cao h∆°i th·∫•p so v·ªõi size ƒë·ªÅ xu·∫•t; c√≥ th·ªÉ c·∫Øt b·ªõt lai n·∫øu mu·ªën √°o g·ªçn h∆°n.`;
      }
    }

    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω theo <b>chi·ªÅu cao &amp; c√¢n n·∫∑ng</b> (${whoLabel}).</div>
      <div class="sugg-card" style="margin-top:8px">
        <div class="sugg-title">
          <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t theo cao &amp; c√¢n n·∫∑ng</b>
        </div>
        <div class="sugg-body">
          <div>Size ƒë·ªÅ xu·∫•t:
            <span class="size-badge">${pick.code}</span>
            ${adjBadge}
          </div>
          <div class="hint" style="margin-top:6px">
            Chi·ªÅu cao nh·∫≠p: <b>${h.toFixed(1)}cm</b> (size theo chi·ªÅu cao: <b>${table[idxH].code}</b>) ¬∑
            C√¢n n·∫∑ng nh·∫≠p: <b>${w.toFixed(1)}kg</b> (size theo c√¢n n·∫∑ng: <b>${table[idxW].code}</b>)
          </div>
          <div class="hint" style="margin-top:4px">${note}</div>
          <div class="cut-main" style="margin-top:8px">${laiText}</div>
          <div class="cut-sub">${laiExplain}</div>
        </div>
      </div>
    `;
    return {ok:true, pickIdx, idxH, idxW, laiText};
  }

  function renderKidsBody(w){
    const err=$("err"), out=$("result");
    const idx = KIDS.findIndex(s=> inRange(w, s.w));
    if(idx===-1){
      err.textContent="C√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tr·∫ª em.";
      err.style.display="block"; out.style.display="none"; return false;
    }
    clearHighlight();
    const tb = document.querySelector("#tableBodyKid");
    if(tb && tb.children[idx]) tb.children[idx].classList.add("pick");
    const p = KIDS[idx];
    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω theo <b>c√¢n n·∫∑ng</b> (Tr·∫ª em)</div>
      <div class="sugg-card" style="margin-top:8px">
        <div class="sugg-title">
          <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t</b>
        </div>
        <div class="sugg-body">
          <div>Size g·ª£i √Ω: <span class="size-badge">${p.code}</span></div>
          <div class="hint" style="margin-top:6px">
            Kho·∫£ng c√¢n n·∫∑ng: <b>${p.w[0]}‚Äì${p.w[1]}kg</b> ‚Ä¢ Tu·ªïi tham kh·∫£o: <b>${p.age}</b>
          </div>
        </div>
      </div>
    `;
    return {ok:true, idx};
  }

  function suggestByBody(){
    const err=$("err"), out=$("result");
    err.style.display="none"; err.textContent=""; out.style.display="none";

    const h=parseNum($("height").value);
    const w=parseNum($("weight").value);
    const g=$("gender").value;

    if(g==="kids"){
      if(Number.isNaN(w)){
        err.textContent="Nh·∫≠p c√¢n n·∫∑ng cho tr·∫ª em.";
        err.style.display="block"; return false;
      }
      return !!renderKidsBody(w);
    } else {
      if(Number.isNaN(h) || Number.isNaN(w)){
        err.textContent="Nh·∫≠p ƒë·ªß chi·ªÅu cao v√† c√¢n n·∫∑ng.";
        err.style.display="block"; return false;
      }
      if(g==="male"){
        return !!renderBodyResultAdult(h,w,MALE,"#tableBodyMale","Nam");
      } else {
        return !!renderBodyResultAdult(h,w,FEMALE,"#tableBodyFemale","N·ªØ");
      }
    }
  }

  /* ====== TEAM ====== */
  let teamRows = [];
  let nextRowId = 1;

  function currentTable(){
    const g = $("gender").value;
    if(g==="male") return MALE;
    if(g==="female") return FEMALE;
    return KIDS;
  }

  function computeTeamByMeasure(){
    const g = $("gender").value;
    const len = parseNum($("len").value);
    const chest = parseNum($("chest").value);
    const sleeve = parseNum($("sleeve").value);
    const table = currentTable();

    if(Number.isNaN(len) && Number.isNaN(chest) && Number.isNaN(sleeve)){
      return {error:"Nh·∫≠p √≠t nh·∫•t 1 trong 3 s·ªë ƒëo √°o."};
    }
    const sugg = calcSuggestions(len, chest, sleeve, table);
    if(!sugg.overall) return {error:"Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size."};

    const idxO = sugg.overall.idx;
    const idxC = sugg.chest?.idx ?? null;
    const sizeO = table[idxO];

    let sizeCustomCode = "";
    let cutText = "";
    if(idxC!=null){
      const sc = table[idxC];
      sizeCustomCode = sc.code;
      if(!Number.isNaN(len) && typeof sc.len==="number"){
        const delta = sc.len - len;
        if(Math.abs(delta)<=1){
          cutText = "Gi·ªØ nguy√™n";
        } else if(delta>1){
          cutText = `C·∫Øt lai ${delta.toFixed(1)}cm`;
        } else {
          cutText = `TƒÉng lai ~${Math.abs(delta).toFixed(1)}cm`;
        }
      }
    }

    return {
      g,
      len,chest,sleeve,
      sizeMain: sizeO.code,
      sizeCustom: sizeCustomCode,
      sizeCustomNote: cutText
    };
  }

  function computeTeamByBody(){
    const g = $("gender").value;
    const h=parseNum($("height").value);
    const w=parseNum($("weight").value);

    if(g==="kids"){
      if(Number.isNaN(w)) return {error:"Nh·∫≠p c√¢n n·∫∑ng cho tr·∫ª em."};
      const idx = KIDS.findIndex(s=> inRange(w, s.w));
      if(idx===-1) return {error:"C√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tr·∫ª em."};
      const size=KIDS[idx].code;
      return {
        g,height:h,weight:w,
        sizeMain:size,
        sizeCustom:size,
        sizeCustomNote:""
      };
    }

    if(Number.isNaN(h) || Number.isNaN(w)) return {error:"Nh·∫≠p ƒë·ªß chi·ªÅu cao v√† c√¢n n·∫∑ng."};
    const table=currentTable();
    const idxH = findNearestByRange(h, table, "h");
    const idxW = findNearestByRange(w, table, "w");
    if(idxH<0 || idxW<0) return {error:"Chi·ªÅu cao ho·∫∑c c√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tham chi·∫øu."};

    const diff=idxH-idxW;
    const absDiff=Math.abs(diff);
    if(absDiff>=3) return {error:"Chi·ªÅu cao v√† c√¢n n·∫∑ng l·ªách tr√™n 2 size, n√™n t∆∞ v·∫•n tr·ª±c ti·∫øp."};

    const sport=$("sport").value;
    const sportBias=SPORT_ADJ[sport]||0;

    let bestSoftIdx=-1, bestSoft=Infinity;
    table.forEach((s,i)=>{
      const sc=softScore(s,w,h,0.65,0.35,sportBias);
      if(sc<bestSoft){bestSoft=sc;bestSoftIdx=i;}
    });

    let pickIdx=bestSoftIdx;
    if(absDiff===2){
      if(diff>0) pickIdx=idxH; else pickIdx=idxW;
    }
    const sizeMain = table[pickIdx];
    const sizeHeight = table[idxH];

    let cutText="";
    if(typeof sizeMain.len==="number" && typeof sizeHeight.len==="number"){
      const delta = sizeHeight.len - sizeMain.len;
      if(Math.abs(delta)<=0.5){
        cutText = "Gi·ªØ nguy√™n";
      } else if(delta>0){
        cutText = `TƒÉng lai ~${delta.toFixed(1)}cm`;
      } else {
        cutText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
      }
    }

    return {
      g,height:h,weight:w,
      sizeMain:sizeMain.code,
      sizeCustom:sizeMain.code,             // << size t√πy ch·ªânh = size ƒë·ªÅ xu·∫•t (L)
      sizeCustomNote: cutText || `cao: ${sizeHeight.code}, n·∫∑ng: ${table[idxW].code}`
    };
  }

  function addTeamRow(record){
    teamRows.push({id:nextRowId++, ...record});
    renderTeamTable();
  }
  function removeTeamMember(id){
    teamRows = teamRows.filter(r=>r.id!==id);
    renderTeamTable();
  }

  function renderTeamTable(){
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const head = $("teamHead");
    const body = $("teamTableBody");
    body.innerHTML="";

    let headerHtml="";
    if(mode==="measure"){
      headerHtml = `
        <tr>
          <th>#</th>
          <th>T√™n</th>
          <th>S·ªë √°o</th>
          <th>D√†i √°o</th>
          <th>Ng·ª±c</th>
          <th>Tay</th>
          <th>Size ƒë·ªÅ xu·∫•t</th>
          <th>Size tu·ª≥ ch·ªânh</th>
          <th></th>
        </tr>`;
    } else {
      headerHtml = `
        <tr>
          <th>#</th>
          <th>T√™n</th>
          <th>S·ªë √°o</th>
          <th>Cao</th>
          <th>N·∫∑ng</th>
          <th>Size ƒë·ªÅ xu·∫•t</th>
          <th>Size tu·ª≥ ch·ªânh</th>
          <th></th>
        </tr>`;
    }
    head.innerHTML = headerHtml;

    const rows = teamRows.filter(r=>r.mode===mode);
    rows.forEach((r,idx)=>{
      const fmt = v => (v==null || Number.isNaN(v)) ? "" : (typeof v==="number" ? v.toFixed(1) : v);
      let tr=document.createElement("tr");
      if(mode==="measure"){
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.name || ""}</td>
          <td>${r.number || ""}</td>
          <td>${fmt(r.len)}</td>
          <td>${fmt(r.chest)}</td>
          <td>${fmt(r.sleeve)}</td>
          <td><b>${r.sizeMain || ""}</b></td>
          <td style="text-align:left">
            ${r.sizeCustom ? `<b>${r.sizeCustom}</b>` : ""}${r.sizeCustomNote ? ` (${r.sizeCustomNote})` : ""}
          </td>
          <td><button type="button" class="btn-del" onclick="removeTeamMember(${r.id})">&times;</button></td>
        `;
      } else {
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.name || ""}</td>
          <td>${r.number || ""}</td>
          <td>${fmt(r.height)}</td>
          <td>${fmt(r.weight)}</td>
          <td><b>${r.sizeMain || ""}</b></td>
          <td style="text-align:left">
            ${r.sizeCustom ? `<b>${r.sizeCustom}</b>` : ""}${r.sizeCustomNote ? ` (${r.sizeCustomNote})` : ""}
          </td>
          <td><button type="button" class="btn-del" onclick="removeTeamMember(${r.id})">&times;</button></td>
        `;
      }
      body.appendChild(tr);
    });
  }

  function clearTeam(){
    teamRows = [];
    renderTeamTable();
  }

  /* ====== CSV ====== */
  function downloadCSV(){
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const rows = teamRows.filter(r=>r.mode===mode);
    if(!rows.length){
      $("err").textContent="Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªôi ·ªü ch·∫ø ƒë·ªô n√†y ƒë·ªÉ xu·∫•t CSV.";
      $("err").style.display="block";
      return;
    }
    $("err").style.display="none";

    let header;
    if(mode==="measure"){
      header = ["#","T√™n","S·ªë √°o","D√†i √°o","Ng·ª±c","Tay","Size ƒë·ªÅ xu·∫•t","Size tu·ª≥ ch·ªânh"];
    } else {
      header = ["#","T√™n","S·ªë √°o","Cao","N·∫∑ng","Size ƒë·ªÅ xu·∫•t","Size tu·ª≥ ch·ªânh"];
    }

    let csv = "\uFEFF" + header.join(",") + "\n";

    rows.forEach((r,idx)=>{
      let vals;
      if(mode==="measure"){
        vals = [
          idx+1,
          r.name || "",
          r.number || "",
          r.len==null || Number.isNaN(r.len) ? "" : r.len,
          r.chest==null || Number.isNaN(r.chest) ? "" : r.chest,
          r.sleeve==null || Number.isNaN(r.sleeve) ? "" : r.sleeve,
          r.sizeMain || "",
          (r.sizeCustom ? r.sizeCustom : "") +
            (r.sizeCustomNote ? (r.sizeCustom ? " - " : "") + r.sizeCustomNote : "")
        ];
      } else {
        vals = [
          idx+1,
          r.name || "",
          r.number || "",
          r.height==null || Number.isNaN(r.height) ? "" : r.height,
          r.weight==null || Number.isNaN(r.weight) ? "" : r.weight,
          r.sizeMain || "",
          (r.sizeCustom ? r.sizeCustom : "") +
            (r.sizeCustomNote ? (r.sizeCustom ? " - " : "") + r.sizeCustomNote : "")
        ];
      }

      const line = vals.map(v=>{
        let s = String(v).replace(/"/g,'""');
        if(/[",\n]/.test(s)) s = `"${s}"`;
        return s;
      }).join(",");
      csv += line + "\n";
    });

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `bang-size-doi-${mode}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ====== G·ª¢I √ù V√Ä TH√äM D√íNG TEAM ====== */
  /* ====== G·ª¢I √ù V√Ä TH√äM D√íNG TEAM ====== */
function handleSuggest(){
  const modeRadio = document.querySelector('input[name="mode"]:checked');
  const currentMode = modeRadio ? modeRadio.value : "measure";

  const name   = $("playerName").value.trim() || "C·∫ßu th·ªß " + (teamRows.length + 1);
  const number = $("playerNumber").value.trim();

  // L·∫•y gi√° tr·ªã 2 nh√≥m
  const len    = parseNum($("len").value);
  const chest  = parseNum($("chest").value);
  const sleeve = parseNum($("sleeve").value);
  const h      = parseNum($("height").value);
  const w      = parseNum($("weight").value);

  // Ki·ªÉm tra: b·∫Øt bu·ªôc nh·∫≠p (len + chest) HO·∫∂C (h + w)
  const hasMeasure = (!Number.isNaN(len) && !Number.isNaN(chest));
  const hasBody    = (!Number.isNaN(h)   && !Number.isNaN(w));

  if (!hasMeasure && !hasBody) {
    $("err").textContent = "Vui l√≤ng nh·∫≠p: (D√†i √°o + Ngang ng·ª±c) HO·∫∂C (Chi·ªÅu cao + C√¢n n·∫∑ng).";
    $("err").style.display = "block";
    $("result").style.display = "none";
    return;
  }

  // N·∫øu ng∆∞·ªùi d√πng nh·∫≠p c·∫£ 2 b·ªô, ∆∞u ti√™n theo tab ƒëang ch·ªçn
  let finalMode;
  if (hasMeasure && hasBody) {
    finalMode = currentMode; // d√πng tab ƒëang active
  } else if (hasMeasure) {
    finalMode = "measure";
  } else {
    finalMode = "body";
  }

  // G·ªçi logic t∆∞∆°ng ·ª©ng + th√™m v√†o danh s√°ch ƒë·ªôi
  let rec, ok;

  if (finalMode === "measure") {
    rec = computeTeamByMeasure();
    if (rec.error) {
      $("err").textContent = rec.error;
      $("err").style.display = "block";
      $("result").style.display = "none";
      return;
    }

    ok = suggestByMeasure();
    if (!ok) return;

    $("err").style.display = "none";
    addTeamRow({ mode: "measure", name, number, ...rec });
  } else {
    rec = computeTeamByBody();
    if (rec.error) {
      $("err").textContent = rec.error;
      $("err").style.display = "block";
      $("result").style.display = "none";
      return;
    }

    ok = suggestByBody();
    if (!ok) return;

    $("err").style.display = "none";
    addTeamRow({ mode: "body", name, number, ...rec });
  }
}


  /* ====== CLEAR & INIT ====== */
  function clearAll(){
    ["len","chest","sleeve","weight","height","playerName","playerNumber"].forEach(id=>{
      const el=$(id); if(el) el.value="";
    });
    $("err").style.display="none"; $("err").textContent="";
    $("result").style.display="none"; $("result").innerHTML="";
    clearHighlight();
  }

  toggleTables();
  renderTeamTable();

  /* ====== EXCEL TEMPLATE & IMPORT ====== */
  function parseGenderLabel(label){
    const s = (label || "").toString().trim().toLowerCase();
    if(!s) return $("gender").value || "male";
    if(s.startsWith("n·ªØ") || s.startsWith("nu")) return "female";
    if(s.startsWith("tr")) return "kids";
    return "male";
  }

  function downloadExcelTemplate(){
    if(typeof XLSX === "undefined"){
      alert("Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán XLSX.");
      return;
    }

    const mode = document.querySelector('input[name="mode"]:checked').value;
    let data, fileName;

    if(mode === "measure"){
      data = [
        ["T√™n", "S·ªë √°o", "ƒê·ªëi t∆∞·ª£ng", "D√†i √°o", "Ng·ª±c", "Tay"],
        ["V√≠ d·ª•: Nam 1", 10, "Nam / N·ªØ / Tr·∫ª em", 70, 52, 22]
      ];
      fileName = "Mau_nhap_thong_so_ao.xlsx";
    } else {
      data = [
        ["T√™n", "S·ªë √°o", "ƒê·ªëi t∆∞·ª£ng", "Chi·ªÅu cao", "C√¢n n·∫∑ng"],
        ["V√≠ d·ª•: Nam 1", 10, "Nam / N·ªØ", 172, 68]
      ];
      fileName = "Mau_nhap_cao_can_nang.xlsx";
    }

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Nhap size");
    XLSX.writeFile(wb, fileName);
  }

  function computeByMeasureFor(g, len, chest, sleeve){
    let table;
    if(g === "female") table = FEMALE;
    else if(g === "kids") table = KIDS;
    else table = MALE;

    if(Number.isNaN(len) && Number.isNaN(chest) && Number.isNaN(sleeve)){
      return { error: "Thi·∫øu 3 s·ªë ƒëo √°o." };
    }

    const sugg = calcSuggestions(len, chest, sleeve, table);
    if(!sugg.overall) return { error: "Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size." };

    const idxO = sugg.overall.idx;
    const idxC = sugg.chest?.idx ?? null;
    const sizeO = table[idxO];

    let sizeCustomCode = "";
    let cutText = "";
    if(idxC != null){
      const sc = table[idxC];
      sizeCustomCode = sc.code;
      if(!Number.isNaN(len) && typeof sc.len === "number"){
        const delta = sc.len - len;
        if(Math.abs(delta) <= 1){
          cutText = "Gi·ªØ nguy√™n";
        } else if(delta > 0){
          cutText = `TƒÉng lai ~${delta.toFixed(1)}cm`;
        } else {
          cutText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
        }
      }
    }

    return {
      g,
      len, chest, sleeve,
      sizeMain: sizeO.code,
      sizeCustom: sizeCustomCode,
      sizeCustomNote: cutText
    };
  }

  function computeByBodyFor(g, h, w){
    if(g === "kids"){
      if(Number.isNaN(w)) return { error: "Thi·∫øu c√¢n n·∫∑ng tr·∫ª em." };
      const idx = KIDS.findIndex(s => inRange(w, s.w));
      if(idx === -1) return { error: "C√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tr·∫ª em." };
      const size = KIDS[idx].code;
      return {
        g, height: h, weight: w,
        sizeMain: size,
        sizeCustom: size,
        sizeCustomNote: ""
      };
    }

    if(Number.isNaN(h) || Number.isNaN(w)){
      return { error: "Thi·∫øu chi·ªÅu cao ho·∫∑c c√¢n n·∫∑ng." };
    }

    let table;
    if(g === "female") table = FEMALE;
    else table = MALE;

    const idxH = findNearestByRange(h, table, "h");
    const idxW = findNearestByRange(w, table, "w");
    if(idxH < 0 || idxW < 0) return { error: "Ngo√†i ph·∫°m vi b·∫£ng tham chi·∫øu." };

    const diff = idxH - idxW;
    const absDiff = Math.abs(diff);
    if(absDiff >= 3) return { error: "Cao & n·∫∑ng l·ªách tr√™n 2 size, n√™n t∆∞ v·∫•n tr·ª±c ti·∫øp." };

    const sportBias = 0;

    let bestSoftIdx = -1, bestSoft = Infinity;
    table.forEach((s, i) => {
      const sc = softScore(s, w, h, 0.65, 0.35, sportBias);
      if(sc < bestSoft){ bestSoft = sc; bestSoftIdx = i; }
    });

    let pickIdx = bestSoftIdx;
    if(absDiff === 2){
      if(diff > 0) pickIdx = idxH; else pickIdx = idxW;
    }
    const sizeMain = table[pickIdx];
    const sizeHeight = table[idxH];

    let cutText = "";
    if(typeof sizeMain.len === "number" && typeof sizeHeight.len === "number"){
      const delta = sizeHeight.len - sizeMain.len;
      if(Math.abs(delta) <= 0.5){
        cutText = "Gi·ªØ nguy√™n";
      } else if(delta > 0){
        cutText = `TƒÉng lai ~${delta.toFixed(1)}cm`;
      } else {
        cutText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
      }
    }

    return {
      g, height: h, weight: w,
      sizeMain: sizeMain.code,
      sizeCustom: sizeMain.code,
      sizeCustomNote: cutText || `cao: ${sizeHeight.code}, n·∫∑ng: ${table[idxW].code}`
    };
  }

  function handleImportExcel(evt){
    const file = evt.target.files[0];
    if(!file) return;

    if(typeof XLSX === "undefined"){
      alert("Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán XLSX.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      const mode = document.querySelector('input[name="mode"]:checked').value;
      let added = 0;

      json.forEach(row => {
        const name = (row["T√™n"] || row["Ten"] || row["Name"] || "").toString().trim();
        const number = (row["S·ªë √°o"] || row["So ao"] || row["So"] || row["Number"] || "").toString().trim();
        const genderLabel = row["ƒê·ªëi t∆∞·ª£ng"] || row["Doi tuong"] || row["Gender"] || "";
        const g = parseGenderLabel(genderLabel);

        if(mode === "measure"){
          const len   = parseNum(row["D√†i √°o"] || row["Dai ao"] || "");
          const chest = parseNum(row["Ng·ª±c"]   || row["Nguc"]   || "");
          const sleeve= parseNum(row["Tay"]    || "");

          const rec = computeByMeasureFor(g, len, chest, sleeve);
          if(rec.error) return;

          addTeamRow({
            mode: "measure",
            name: name || ("C·∫ßu th·ªß " + (teamRows.length + 1)),
            number,
            ...rec
          });
          added++;
        } else {
          const h = parseNum(row["Chi·ªÅu cao"] || row["Chieu cao"] || row["Cao"] || "");
          const w = parseNum(row["C√¢n n·∫∑ng"]  || row["Can nang"]  || row["N·∫∑ng"] || "");

          const rec = computeByBodyFor(g, h, w);
          if(rec.error) return;

          addTeamRow({
            mode: "body",
            name: name || ("C·∫ßu th·ªß " + (teamRows.length + 1)),
            number,
            ...rec
          });
          added++;
        }
      });

      if(!added){
        alert("Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá trong file Excel (ki·ªÉm tra t√™n c·ªôt & d·ªØ li·ªáu).");
      } else {
        $("err").style.display = "none";
      }

      evt.target.value = "";
    };

    reader.readAsArrayBuffer(file);
  }

  /* ====== ENTER ƒê·ªÇ G·ª¢I √ù ====== */
  ["len","chest","sleeve","weight","height"].forEach(id=>{
    const el=$(id); if(!el) return;
    el.addEventListener("keydown",e=>{
      if(e.key==="Enter"){ e.preventDefault(); handleSuggest(); }
    });
  });
lucide.createIcons();
function shareTeam(){
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const rows = teamRows.filter(r => r.mode === mode);

  if (!rows.length) {
    $("err").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªôi ·ªü ch·∫ø ƒë·ªô n√†y ƒë·ªÉ chia s·∫ª.";
    $("err").style.display = "block";
    return;
  }
  $("err").style.display = "none";

  const fmt = v => (v == null || Number.isNaN(v))
    ? ""
    : (typeof v === "number" ? v.toFixed(1) : v);

  let lines = [];

  if (mode === "measure") {
    lines.push("# | T√™n | S·ªë √°o | D√†i √°o | Ng·ª±c | Tay | Size ƒë·ªÅ xu·∫•t | Size tu·ª≥ ch·ªânh");
  } else {
    lines.push("# | T√™n | S·ªë √°o | Cao | N·∫∑ng | Size ƒë·ªÅ xu·∫•t | Size tu·ª≥ ch·ªânh");
  }

  rows.forEach((r, idx) => {
    const baseInfo = `${idx+1} | ${r.name || ""} | ${r.number || ""}`;
    if (mode === "measure") {
      lines.push(
        `${baseInfo} | ${fmt(r.len)} | ${fmt(r.chest)} | ${fmt(r.sleeve)} | ` +
        `${r.sizeMain || ""} | ${(r.sizeCustom || "") + (r.sizeCustomNote ? ` (${r.sizeCustomNote})` : "")}`
      );
    } else {
      lines.push(
        `${baseInfo} | ${fmt(r.height)} | ${fmt(r.weight)} | ` +
        `${r.sizeMain || ""} | ${(r.sizeCustom || "") + (r.sizeCustomNote ? ` (${r.sizeCustomNote})` : "")}`
      );
    }
  });

  const text = lines.join("\n");

  // N·∫øu tr√¨nh duy·ªát h·ªó tr·ª£ Web Share API
  if (navigator.share) {
    navigator.share({
      title: "Danh s√°ch size ƒë·ªôi",
      text: text
    }).catch(() => {
      // ng∆∞·ªùi d√πng b·∫•m h·ªßy th√¨ th√¥i, kh√¥ng b√°o l·ªói
    });
  } 
  // fallback: copy v√†o clipboard
  else if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert("ƒê√£ copy danh s√°ch size v√†o clipboard. B·∫°n c√≥ th·ªÉ d√°n v√†o Zalo/Facebook/Email ƒë·ªÉ chia s·∫ª.");
    }).catch(() => {
      alert("Kh√¥ng copy ƒë∆∞·ª£c v√†o clipboard. B·∫°n vui l√≤ng ch·ªçn & copy th·ªß c√¥ng nh√©.");
    });
  } 
  // fallback cu·ªëi
  else {
    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ chia s·∫ª nhanh. B·∫°n c√≥ th·ªÉ d√πng n√∫t T·∫£i v·ªÅ r·ªìi g·ª≠i file CSV.");
  }
}
function openGuide(){
  document.getElementById("excelGuidePopup").style.display = "flex";
}

function closeGuide(){
  document.getElementById("excelGuidePopup").style.display = "none";
}

</script>
</body>
</html>
